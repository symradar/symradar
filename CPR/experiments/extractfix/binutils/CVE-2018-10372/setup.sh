project_name=binutils
bug_id=CVE-2018-10372
dir_name=$1/extractfix/$project_name/$bug_id

project_url=https://sourceware.org/git/binutils-gdb.git
commit_id=c48935d75f720ecb006c81b37f4058e751f1dc31


current_dir=$PWD
mkdir -p $dir_name
cd $dir_name
git clone $project_url src
cd src
git checkout $commit_id

CC=wllvm CXX=wllvm++ CFLAGS="-g -O0" CXXFLAGS="$CFLAGS" ./configure --disable-shared --disable-gdb --disable-libdecnumber --disable-readline --disable-sim --disable-werror
make -j32


sed -i '9291i }\n' binutils/dwarf.c
sed -i '9290i CPR_OUTPUT("obs", "i32", x -num);\n' binutils/dwarf.c
sed -i '9289d' binutils/dwarf.c
sed -i '9289i if(!do_display) { if(__cpr_choice("L2440", "bool", (int[]){limit, num, ph}, (char*[]){"x", "y", "z"},3, (int*[]){}, (char*[]){}, 0)) return 0;' binutils/dwarf.c
sed -i '9289i  size_t num = sizeof (uint64_t);size_t x = limit - ph;' binutils/dwarf.c
sed -i '33i #ifndef CPR_OUTPUT\n#define CPR_OUTPUT(id, typestr, value) value\n#endif\n' binutils/dwarf.c
git add binutils/dwarf.c
git commit -m "instrument cpr"
cd binutils
make CXX=$CPR_CXX CC=$CPR_CC  -j32

cd $current_dir
cp repair.conf $dir_name
cp spec.smt2 $dir_name
cp t1.smt2 $dir_name
cp -rf components $dir_name
cp exploit.bin $dir_name
