#!/bin/bash

rm -rf source
git clone https://github.com/vadz/libtiff.git source
pushd source
  git checkout 891b1b9
  wget http://www.ijg.org/files/jpegsrc.v8d.tar.gz
  tar xvzf jpegsrc.v8d.tar.gz
  pushd jpeg-8d
    ./configure --prefix=${PWD}/build
    make -j32 install
    export JPEG_PATH=${PWD}/build
  popd
popd

export AFLRUN=/root/projects/AFLRun
rm -rf aflrun_build && mkdir aflrun_build
pushd aflrun_build
  mkdir temp
  TMP_DIR=$PWD/temp
  mkdir aflrun_tmp
  export AFLRUN_TMP=$PWD/aflrun_tmp
  echo "tiff2pdf.c:2898" > $TMP_DIR/BBtargets.txt
  export AFLRUN_BB_TARGETS=$TMP_DIR/BBtargets.txt
  export AFLRUN_TARGETS="tiff2pdf"
  # export ADDITIONAL_FLAGS="-flto -fuse-ld=gold -Wl,-plugin-opt=save-temps"
  export FORCE_UNSAFE_CONFIGURE=1
  CC=$AFLRUN/afl-clang-lto CXX=$AFLRUN/afl-clang-lto++ ASAN_OPTIONS=detect_leaks=0 ../source/configure --enable-static --disable-shared --without-threads --without-lzma --enable-old-jpeg --with-jpeg-include-dir="$JPEG_PATH/include" --with-jpeg-lib-dir="$JPEG_PATH/lib"
  CC=$AFLRUN/afl-clang-lto CXX=$AFLRUN/afl-clang-lto++ ASAN_OPTIONS=detect_leaks=0 make CFLAGS="-static -fsanitize=address -fsanitize=undefined -g -flto -fuse-ld=gold -Wl,-plugin-opt=save-temps" CXXFLAGS="-static -fsanitize=address -fsanitize=undefined -g -flto -fuse-ld=gold -Wl,-plugin-opt=save-temps" -j10
popd

rm -rf runtime && mkdir runtime
cp aflrun_build/tools/tiff2pdf runtime/tiff2pdf.aflrun

# AFL_NO_UI=1 timeout 12h /home/yuntong/vulnfix/thirdparty/DAFL/afl-fuzz -C -t 2000ms -m none -i ./in -p /home/yuntong/vulnfix/data/libtiff/cve_2016_5321/sparrow-out/bug/slice_dfg.txt -o 2024-04-04-test -- ./tiffcrop.instrumented @@ /tmp/out.tmp

