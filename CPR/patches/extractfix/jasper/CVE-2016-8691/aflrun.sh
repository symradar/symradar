#!/bin/bash
rm -rf aflrun_build
project_url=https://github.com/jasper-software/jasper.git
commit_id=3c55b39
export AFLRUN=/root/projects/AFLRun
git clone $project_url aflrun_build
pushd aflrun_build
  git checkout $commit_id
  sed -i "s/inline bool jas_safe_size_mul/inline static bool jas_safe_size_mul/g" src/libjasper/base/jas_malloc.c
  autoreconf -i
  mkdir temp
  TMP_DIR=$PWD/temp
  mkdir aflrun_tmp
  export AFLRUN_TMP=$PWD/aflrun_tmp
  echo "jpc_dec.c:1195" > $TMP_DIR/BBtargets.txt
  export AFLRUN_BB_TARGETS=$TMP_DIR/BBtargets.txt
  export AFLRUN_TARGETS="imginfo"
  # export ADDITIONAL_FLAGS="-flto -fuse-ld=gold -Wl,-plugin-opt=save-temps"
  export FORCE_UNSAFE_CONFIGURE=1
  CC=$AFLRUN/afl-clang-lto CXX=$AFLRUN/afl-clang-lto++ ASAN_OPTIONS=detect_leaks=0 ./configure --without-simd --enable-static --disable-shared
  CC=$AFLRUN/afl-clang-lto CXX=$AFLRUN/afl-clang-lto++ ASAN_OPTIONS=detect_leaks=0 make CFLAGS="-static -fsanitize=address -g" CXXFLAGS="-static -fsanitize=address -g" -j 10
popd

rm -rf runtime && mkdir runtime
cp aflrun_build/src/appl/imginfo runtime/imginfo.aflrun
