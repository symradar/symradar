project_name=libjpeg
bug_id=CVE-2018-19664
dir_name=$1/extractfix/$project_name/$bug_id

project_url=https://github.com/libjpeg-turbo/libjpeg-turbo.git
commit_id=beefb62

current_dir=$PWD

mkdir -p $dir_name
cd $dir_name
git clone $project_url src
cd src
git checkout $commit_id


mkdir build; cd build;
cmake -G"Unix Makefiles" -DCMAKE_C_COMPILER=$CPR_CC -DCMAKE_EXE_LINKER_FLAGS='-lkleeRuntest' -DCMAKE_C_FLAGS_RELEASE='-g -O0 -D_NO_STRING_INLINES -DFORTIFY_SOURCE=0' -DREQUIRE_SIMD=0 -DWITH_SIMD=0 ..
make -j32
cd ..;
sed -i '511i if(cinfo->quantize_colors) klee_abort();' wrbmp.c
sed -i '505d;506d' wrbmp.c
sed -i '505i CPR_OUTPUT("obs", "i32", cinfo->quantize_colors );\n' wrbmp.c
sed -i '505i   } else if ( __cpr_choice("L1229", "bool", (int[]){cinfo->quantize_colors, dest->pub.put_pixel_rows}, (char*[]){"x", "y"}, 2, (int*[]){}, (char*[]){}, 0) && (cinfo->out_color_space == JCS_RGB565 || cinfo->out_color_space == JCS_CMYK)) {' wrbmp.c
sed -i '27i #ifndef CPR_OUTPUT\n#define CPR_OUTPUT(id, typestr, value) value\n#endif\n' wrbmp.c


git add wrbmp.c
git commit -m "instrument cpr"
cd build; make -j32

cd $current_dir
cp repair.conf $dir_name
cp spec.smt2 $dir_name
cp t1.smt2 $dir_name
cp -rf components $dir_name
cp exploit.jpg $dir_name

