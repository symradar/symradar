#!/bin/bash
rm -rf source
project_url=https://github.com/libjpeg-turbo/libjpeg-turbo.git
commit_id=beefb62
git clone $project_url source
pushd source
  git checkout $commit_id
popd

export AFLRUN=/root/projects/AFLRun
export PATH=$AFLRUN/thirdparty/install/bin:$PATH
rm -rf aflrun_build && mkdir aflrun_build
pushd aflrun_build
  mkdir temp
  TMP_DIR=$PWD/temp
  mkdir aflrun_tmp
  export AFLRUN_TMP=$PWD/aflrun_tmp
  echo "wrbmp.c:505" > $TMP_DIR/BBtargets.txt
  export AFLRUN_BB_TARGETS=$TMP_DIR/BBtargets.txt
  export AFLRUN_TARGETS="djpeg-static"
  cmake -G"Unix Makefiles" -DCMAKE_C_COMPILER=$AFLRUN/afl-clang-lto -DCMAKE_CXX_COMPILER=$AFLRUN/afl-clang-lto++  -DREQUIRE_SIMD=0 -DWITH_SIMD=0 -DCMAKE_C_FLAGS="-g -O0 -fno-discard-value-names" -DCMAKE_CXX_FLAGS="-g -O0 -fno-discard-value-names" -DCMAKE_C_FLAGS_RELEASE="-g -O0 -fno-discard-value-names -D_NO_STRING_INLINES -DFORTIFY_SOURCE=0" ../source
  make -j16
popd

rm -rf runtime && mkdir runtime
cp aflrun_build/djpeg-static runtime/djpeg-static.aflrun


# AFL_NO_UI=1 timeout 12h /home/yuntong/vulnfix/thirdparty/DAFL/afl-fuzz -C -t 2000ms -m none -i ./in -p /home/yuntong/vulnfix/data/libtiff/cve_2016_5321/sparrow-out/bug/slice_dfg.txt -o 2024-04-04-test -- ./tiffcrop.instrumented @@ /tmp/out.tmp


